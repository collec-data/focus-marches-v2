docker-image-api:
  extends: .build-docker
  variables:
    IMAGE: "${REGISTRY}focus-marches-v2/api"
    BUILD_CONTEXT: "api/."

api-quality:
  stage: üîç build-quality
  image: python:3.13.7-alpine@sha256:9ba6d8cbebf0fb6546ae71f2a1c14f6ffd2fdab83af7fa5669734ef30ad48844
  variables:
    FORCE_COLOR: true
  script:
    - python3 -m venv .venv
    - source .venv/bin/activate
    - cd api
    - pip install --upgrade pip
    - pip install -r dev-requirements.txt
    - unset DOCKER_AUTH_CONFIG # XXX: On ignore la configuration au sein des tests du √† une incompatibilit√© avec testcontainers
    - coverage run -m pytest --cov-report xml:cov.xml --cov-report=term
    - ruff format --check . || touch failed
    - ruff check . || touch failed
    - mypy . --strict || touch failed
    - '[ ! -e failed ] || ( echo "Ruff et/ou mypy ont remont√© des erreurs, voir les logs pr√©c√©dents"; exit 1 )'
  coverage: '/TOTAL.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: api/cov.xml
