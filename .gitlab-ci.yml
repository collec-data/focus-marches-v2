.build-docker:
  image: docker:stable-dind@sha256:4972457c6a8a4309f9796fc3c8fd288923045ba0e214c102d92b70be99e249d1
  stage: üî® docker-build
  variables:
    IMAGE: ""
    DOCKERFILE: ""
  script:
    - echo $IMAGE
    - echo $CI_COMMIT_TAG
    - >
      if [[ "$CI_COMMIT_TAG" == "" ]]; then
        echo "TAG VIDE";
        IMAGE_BUILD=${IMAGE};
        VERSION_IMAGE=${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHA:0:8}-snapshot;
      else
        echo "TAG PAS VIDE";
        IMAGE_BUILD=${IMAGE};
        VERSION_IMAGE=${CI_COMMIT_REF_NAME};
      fi
    - echo ${VERSION_IMAGE}
    - echo ${IMAGE_BUILD}
    - docker build -f ${BUILD_CONTEXT}/Dockerfile -t ${IMAGE_BUILD} ${BUILD_CONTEXT}
    - echo ${REGISTRY_PASSWORD} | docker login ${REGISTRY} -u ${REGISTRY_USER} --password-stdin
    - docker tag ${IMAGE_BUILD} ${IMAGE_BUILD}:${VERSION_IMAGE}
    - echo "push ${IMAGE_BUILD}:${VERSION_IMAGE}" && docker push ${IMAGE_BUILD}:${VERSION_IMAGE}

include:
  - /api/.gitlab-ci.yml
  - /front/.gitlab-ci.yml

stages:
  - üîç build-quality
  - üî® docker-build
